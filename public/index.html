<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Context Lens</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      padding: 20px;
    }
    h1 { font-size: 24px; margin-bottom: 20px; color: #fff; }

    /* Cards */
    .request-card {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      transition: border-color 0.2s;
    }
    .request-card:hover { border-color: #555; }
    .request-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .provider-badge {
      display: inline-block; padding: 4px 8px; border-radius: 4px;
      font-size: 12px; font-weight: 600; text-transform: uppercase;
    }
    .provider-anthropic { background: #d4a574; color: #000; }
    .provider-openai { background: #10a37f; color: #fff; }
    .provider-chatgpt { background: #10a37f; color: #fff; }
    .provider-unknown { background: #666; color: #fff; }
    .source-badge {
      display: inline-block; padding: 4px 8px; border-radius: 4px;
      font-size: 11px; font-weight: 600;
      background: #2a2a2a; color: #4a90e2; border: 1px solid #4a90e2; margin-left: 8px;
    }
    .model-name { font-size: 14px; color: #999; }
    .timestamp { font-size: 12px; color: #666; }

    /* Context bar */
    .context-bar {
      height: 24px; display: flex; border-radius: 4px;
      overflow: hidden; margin-bottom: 8px; background: #252525;
    }
    .bar-segment { height: 100%; transition: width 0.3s; }
    .bar-system { background: #4a90e2; }
    .bar-tools { background: #e24a90; }
    .bar-messages { background: #90e24a; }
    .context-stats { display: flex; gap: 16px; font-size: 13px; margin-bottom: 8px; flex-wrap: wrap; }
    .stat { display: flex; align-items: center; gap: 6px; }
    .stat-dot { width: 8px; height: 8px; border-radius: 50%; }
    .usage-indicator { font-size: 14px; font-weight: 600; color: #4a90e2; }
    .usage-high { color: #e2a54a; }
    .usage-critical { color: #e24a4a; }

    /* Collapsible sections */
    .details {
      display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid #333;
    }
    .details.expanded { display: block; }
    .section-title {
      font-weight: 600; margin-top: 12px; margin-bottom: 8px; color: #fff; cursor: pointer;
      user-select: none;
    }
    .section-title:hover { color: #4a90e2; }
    .message-list { margin-top: 8px; }
    .message-item {
      background: #252525; padding: 8px 12px; border-radius: 4px;
      margin-bottom: 8px; font-size: 13px;
    }
    .message-role { font-weight: 600; color: #4a90e2; margin-bottom: 4px; }
    .message-content {
      color: #ccc; white-space: pre-wrap; word-break: break-word;
      max-height: 200px; overflow-y: auto;
    }
    .message-tokens { color: #666; font-size: 11px; margin-top: 4px; }

    /* System prompt collapsible */
    .system-prompt-content {
      font-family: "SF Mono", "Fira Code", "Consolas", monospace;
      font-size: 12px; color: #ccc; white-space: pre-wrap; word-break: break-word;
      max-height: 150px; overflow: hidden; position: relative;
      transition: max-height 0.3s;
    }
    .system-prompt-content.expanded { max-height: none; }
    .system-prompt-content:not(.expanded)::after {
      content: ''; position: absolute; bottom: 0; left: 0; right: 0;
      height: 40px; background: linear-gradient(transparent, #252525);
    }
    .toggle-btn {
      background: none; border: 1px solid #444; color: #4a90e2;
      padding: 2px 10px; border-radius: 4px; cursor: pointer;
      font-size: 11px; margin-top: 4px; display: inline-block;
    }
    .toggle-btn:hover { border-color: #4a90e2; }

    /* Content block labels */
    .block-label {
      display: inline-block; padding: 1px 6px; border-radius: 3px;
      font-size: 10px; font-weight: 600; text-transform: uppercase; margin-right: 6px;
    }
    .block-label-text { background: #1a3a1a; color: #90e24a; }
    .block-label-tool_use { background: #3a1a2a; color: #e24a90; }
    .block-label-tool_result { background: #1a2a3a; color: #4a90e2; }

    /* Tool items */
    .tool-item {
      background: #252525; border-radius: 4px; margin-bottom: 6px; overflow: hidden;
    }
    .tool-item-header {
      padding: 6px 12px; cursor: pointer; font-size: 13px; font-weight: 500;
      color: #e24a90; user-select: none;
    }
    .tool-item-header:hover { background: #2a2a2a; }
    .tool-item-body {
      display: none; padding: 8px 12px; border-top: 1px solid #333;
      font-family: "SF Mono", "Fira Code", "Consolas", monospace;
      font-size: 11px; color: #aaa; white-space: pre-wrap; word-break: break-word;
      max-height: 300px; overflow-y: auto;
    }
    .tool-item-body.expanded { display: block; }

    /* Conversation groups */
    .conversation-group {
      border: 1px solid #333; border-radius: 8px; margin-bottom: 16px;
      overflow: hidden;
    }
    .conversation-header {
      background: #1e1e1e; padding: 12px 16px; cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
      user-select: none;
    }
    .conversation-header:hover { background: #252525; }
    .conversation-label {
      font-size: 13px; color: #ccc; max-width: 500px;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .turn-count {
      display: inline-block; padding: 2px 8px; border-radius: 10px;
      font-size: 11px; font-weight: 600; background: #333; color: #aaa; margin-left: 8px;
    }
    .conversation-body { display: none; }
    .conversation-body.expanded { display: block; }
    .turn-label {
      font-size: 11px; font-weight: 600; color: #666;
      padding: 4px 16px; background: #151515; border-top: 1px solid #2a2a2a;
    }
    .turn-card {
      padding: 16px; border-top: 1px solid #2a2a2a;
    }
    .turn-card .request-header { margin-bottom: 8px; }

    .clickable { cursor: pointer; }

    /* Agent sub-groups within a session */
    .agent-group {
      border-top: 1px solid #2a2a2a;
    }
    .agent-header {
      padding: 8px 16px; cursor: pointer; user-select: none;
      display: flex; justify-content: space-between; align-items: center;
      background: #161616;
    }
    .agent-header:hover { background: #1e1e1e; }
    .agent-label {
      font-size: 12px; color: #aaa; max-width: 400px;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .agent-model {
      font-size: 11px; color: #666; font-family: "SF Mono", "Fira Code", "Consolas", monospace;
    }
    .agent-body { display: none; }
    .agent-body.expanded { display: block; }

    .working-dir {
      font-size: 11px; color: #777; font-family: "SF Mono", "Fira Code", "Consolas", monospace;
      margin-top: 2px;
    }

    .empty-state { text-align: center; padding: 60px 20px; color: #666; }
  </style>
</head>
<body>
  <h1>Context Lens</h1>
  <div id="requests-container"></div>
  <div id="empty-state" class="empty-state" style="display: none;">
    <p>No requests captured yet.</p>
    <p style="margin-top: 8px; font-size: 14px;">Point your LLM API calls to port 4040 to start capturing.</p>
  </div>

  <script>
    let currentData = null;
    const expandedState = new Set(); // track expanded IDs across re-renders

    function esc(str) {
      if (!str) return '';
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function cap(text, limit) {
      limit = limit || 10000;
      if (!text) return '';
      if (text.length <= limit) return text;
      return text.slice(0, limit) + '\n... [truncated at ' + limit.toLocaleString() + ' chars]';
    }

    function formatTimestamp(iso) {
      const d = new Date(iso);
      return d.toLocaleTimeString() + ' ' + d.toLocaleDateString();
    }

    function toggle(id) {
      const el = document.getElementById(id);
      if (!el) return;
      if (expandedState.has(id)) {
        expandedState.delete(id);
        el.classList.remove('expanded');
      } else {
        expandedState.add(id);
        el.classList.add('expanded');
      }
    }

    function renderContextBar(info, limit) {
      const total = info.totalTokens || 0;
      const usagePercent = limit ? Math.round((total / limit) * 100) : 0;
      let usageClass = 'usage-indicator';
      if (usagePercent > 80) usageClass += ' usage-critical';
      else if (usagePercent > 60) usageClass += ' usage-high';

      const systemPct = total ? (info.systemTokens / total) * 100 : 0;
      const toolsPct = total ? (info.toolsTokens / total) * 100 : 0;
      const msgsPct = total ? (info.messagesTokens / total) * 100 : 0;

      return '<div class="context-bar">'
        + '<div class="bar-segment bar-system" style="width:' + systemPct + '%"></div>'
        + '<div class="bar-segment bar-tools" style="width:' + toolsPct + '%"></div>'
        + '<div class="bar-segment bar-messages" style="width:' + msgsPct + '%"></div>'
        + '</div>'
        + '<div class="context-stats">'
        + '<div class="stat"><span class="stat-dot bar-system"></span><span>System: ' + info.systemTokens.toLocaleString() + ' tokens</span></div>'
        + '<div class="stat"><span class="stat-dot bar-tools"></span><span>Tools: ' + info.toolsTokens.toLocaleString() + ' tokens</span></div>'
        + '<div class="stat"><span class="stat-dot bar-messages"></span><span>Messages: ' + info.messagesTokens.toLocaleString() + ' tokens</span></div>'
        + '</div>'
        + '<div style="margin-top:8px;">'
        + '<span class="' + usageClass + '">' + usagePercent + '% of context used</span>'
        + '<span style="color:#666;margin-left:8px;">(' + total.toLocaleString() + ' / ' + limit.toLocaleString() + ' tokens)</span>'
        + '</div>';
    }

    function renderContentBlock(block, reqId, idx) {
      if (!block || typeof block !== 'object') return '<div class="message-item">' + esc(String(block)) + '</div>';
      const type = block.type || 'unknown';

      if (type === 'text') {
        return '<div class="message-item">'
          + '<span class="block-label block-label-text">text</span>'
          + '<div class="message-content">' + esc(cap(block.text || '')) + '</div>'
          + '</div>';
      }
      if (type === 'tool_use') {
        const inputJson = block.input ? JSON.stringify(block.input, null, 2) : '{}';
        const bodyId = 'cb-' + reqId + '-' + idx;
        return '<div class="message-item">'
          + '<span class="block-label block-label-tool_use">tool_use</span>'
          + '<strong style="color:#e24a90">' + esc(block.name || 'unnamed') + '</strong>'
          + '<div id="' + bodyId + '" class="tool-item-body' + (expandedState.has(bodyId) ? ' expanded' : '') + '">'
          + esc(cap(inputJson)) + '</div>'
          + '<button class="toggle-btn" onclick="event.stopPropagation();toggle(\'' + bodyId + '\')">toggle input</button>'
          + '</div>';
      }
      if (type === 'tool_result') {
        let resultText = '';
        if (typeof block.content === 'string') resultText = block.content;
        else if (Array.isArray(block.content)) {
          resultText = block.content.map(function(c) {
            if (c.type === 'image') return '[image content]';
            return c.text || JSON.stringify(c);
          }).join('\n');
        } else if (block.content) resultText = JSON.stringify(block.content);
        return '<div class="message-item">'
          + '<span class="block-label block-label-tool_result">tool_result</span>'
          + '<div class="message-content">' + esc(cap(resultText)) + '</div>'
          + '</div>';
      }
      if (type === 'image') {
        return '<div class="message-item"><span class="block-label" style="background:#333;color:#aaa">image</span> [image content]</div>';
      }
      // Fallback
      return '<div class="message-item"><div class="message-content">' + esc(cap(JSON.stringify(block, null, 2))) + '</div></div>';
    }

    function renderMessage(msg, reqId, msgIdx) {
      const blocks = msg.contentBlocks;
      let contentHtml = '';
      if (blocks && Array.isArray(blocks) && blocks.length > 0) {
        contentHtml = blocks.map(function(b, i) { return renderContentBlock(b, reqId, msgIdx + '-' + i); }).join('');
      } else {
        // Check if stringified content might contain image base64
        let display = msg.content || '';
        if (display.length > 500 && /data:image|base64,/.test(display.slice(0, 200))) {
          display = '[contains image data - ' + display.length + ' chars]';
        }
        contentHtml = '<div class="message-content">' + esc(cap(display)) + '</div>';
      }
      return '<div class="message-item">'
        + '<div class="message-role">' + esc(msg.role) + '</div>'
        + contentHtml
        + '<div class="message-tokens">' + (msg.tokens || 0).toLocaleString() + ' tokens</div>'
        + '</div>';
    }

    function renderDetails(req, detailsId) {
      const info = req.contextInfo;
      const isExp = expandedState.has(detailsId);
      let html = '<div id="' + detailsId + '" class="details' + (isExp ? ' expanded' : '') + '">';

      // System prompts
      if (info.systemPrompts && info.systemPrompts.length > 0) {
        html += '<div class="section-title">System Prompts</div>';
        info.systemPrompts.forEach(function(sp, i) {
          const spId = detailsId + '-sp-' + i;
          const spExp = expandedState.has(spId);
          html += '<div class="message-item">'
            + '<div id="' + spId + '" class="system-prompt-content' + (spExp ? ' expanded' : '') + '">'
            + esc(cap(sp.content)) + '</div>'
            + '<button class="toggle-btn" onclick="event.stopPropagation();toggle(\'' + spId + '\')">'
            + (spExp ? 'Show less' : 'Show more') + '</button></div>';
        });
      }

      // Tools
      if (info.tools && info.tools.length > 0) {
        html += '<div class="section-title">Tools (' + info.tools.length + ')</div>';
        info.tools.forEach(function(t, i) {
          const name = t.name || (t.function && t.function.name) || 'unnamed';
          const desc = t.description || (t.function && t.function.description) || '';
          const schema = t.input_schema || (t.function && t.function.parameters) || null;
          const toolId = detailsId + '-tool-' + i;
          const tExp = expandedState.has(toolId);
          html += '<div class="tool-item">'
            + '<div class="tool-item-header" onclick="event.stopPropagation();toggle(\'' + toolId + '\')">'
            + esc(name) + '</div>'
            + '<div id="' + toolId + '" class="tool-item-body' + (tExp ? ' expanded' : '') + '">'
            + (desc ? esc(desc) + '\n\n' : '')
            + (schema ? esc(JSON.stringify(schema, null, 2)) : '')
            + '</div></div>';
        });
      }

      // Messages
      if (info.messages && info.messages.length > 0) {
        html += '<div class="section-title">Messages (' + info.messages.length + ')</div>';
        html += '<div class="message-list">';
        info.messages.forEach(function(msg, i) {
          html += renderMessage(msg, req.id, i);
        });
        html += '</div>';
      }

      html += '</div>';
      return html;
    }

    function renderSingleCard(req) {
      const info = req.contextInfo;
      const detailsId = 'details-' + req.id;
      return '<div class="request-card">'
        + '<div class="request-header clickable" onclick="toggle(\'' + detailsId + '\')"><div>'
        + '<span class="provider-badge provider-' + esc(info.provider) + '">' + esc(info.provider) + '</span>'
        + (req.source && req.source !== 'unknown' ? '<span class="source-badge">' + esc(req.source) + '</span>' : '')
        + ' <span class="model-name">' + esc(info.model) + '</span>'
        + '</div><span class="timestamp">' + esc(formatTimestamp(req.timestamp)) + '</span></div>'
        + '<div class="clickable" onclick="toggle(\'' + detailsId + '\')">'
        + renderContextBar(info, req.contextLimit)
        + '</div>'
        + renderDetails(req, detailsId)
        + '</div>';
    }

    function renderAgentTurns(agent, convoId) {
      const entries = agent.entries;
      let html = '';
      entries.forEach(function(entry, i) {
        const detailsId = 'details-' + entry.id;
        html += '<div class="turn-label">Turn ' + (entries.length - i) + ' / ' + entries.length
          + ' &mdash; ' + esc(formatTimestamp(entry.timestamp)) + '</div>';
        html += '<div class="turn-card">';
        html += '<div class="clickable" onclick="event.stopPropagation();toggle(\'' + detailsId + '\')">';
        html += renderContextBar(entry.contextInfo, entry.contextLimit);
        html += '</div>';
        html += renderDetails(entry, detailsId);
        html += '</div>';
      });
      return html;
    }

    function renderConversationGroup(convo) {
      const entries = convo.entries; // newest-first
      const agents = convo.agents || [];
      const latest = entries[0];
      const info = latest.contextInfo;
      const bodyId = 'convo-body-' + convo.id;
      const isExp = expandedState.has(bodyId);
      const hasAgents = agents.length > 1;

      let html = '<div class="conversation-group">';
      // Header
      html += '<div class="conversation-header" onclick="toggle(\'' + bodyId + '\')">';
      html += '<div>';
      html += '<span class="provider-badge provider-' + esc(info.provider) + '">' + esc(info.provider) + '</span>';
      if (convo.source && convo.source !== 'unknown') html += '<span class="source-badge">' + esc(convo.source) + '</span>';
      if (hasAgents) {
        html += '<span class="turn-count">' + agents.length + ' agents, ' + entries.length + ' calls</span>';
      } else {
        html += ' <span class="model-name">' + esc(info.model) + '</span>';
        html += '<span class="turn-count">' + entries.length + ' turns</span>';
      }
      html += '</div>';
      html += '<div>';
      html += '<span class="conversation-label">' + esc(convo.label) + '</span>';
      html += ' <span class="timestamp">' + esc(formatTimestamp(latest.timestamp)) + '</span>';
      if (convo.workingDirectory) html += '<div class="working-dir">' + esc(convo.workingDirectory) + '</div>';
      html += '</div></div>';

      // Summary (always visible): latest request's context bar
      html += '<div style="padding:12px 16px;background:#1a1a1a;">'
        + renderContextBar(info, latest.contextLimit) + '</div>';

      // Expandable body
      html += '<div id="' + bodyId + '" class="conversation-body' + (isExp ? ' expanded' : '') + '">';

      if (hasAgents) {
        // Multi-agent: render each agent as a collapsible sub-group
        agents.forEach(function(agent) {
          const agentBodyId = 'agent-' + convo.id + '-' + agent.key;
          const aExp = expandedState.has(agentBodyId);
          const turnText = agent.entries.length === 1 ? '1 turn' : agent.entries.length + ' turns';
          html += '<div class="agent-group">';
          html += '<div class="agent-header" onclick="event.stopPropagation();toggle(\'' + agentBodyId + '\')">';
          html += '<div>';
          html += '<span class="agent-model">' + esc(agent.model) + '</span> ';
          html += '<span class="agent-label">' + esc(agent.label) + '</span>';
          html += '</div>';
          html += '<span class="turn-count">' + turnText + '</span>';
          html += '</div>';
          html += '<div id="' + agentBodyId + '" class="agent-body' + (aExp ? ' expanded' : '') + '">';
          html += renderAgentTurns(agent, convo.id);
          html += '</div></div>';
        });
      } else {
        // Single agent: render turns directly
        html += renderAgentTurns(agents[0] || { entries: entries }, convo.id);
      }

      html += '</div></div>';
      return html;
    }

    function renderConversations(data) {
      const container = document.getElementById('requests-container');
      const emptyState = document.getElementById('empty-state');
      const convos = data.conversations || [];
      const ungrouped = data.ungrouped || [];

      if (convos.length === 0 && ungrouped.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      emptyState.style.display = 'none';

      // Merge into a single timeline sorted by most recent entry
      const items = [];
      convos.forEach(function(c) {
        const latest = c.entries[0];
        items.push({ type: c.entries.length === 1 ? 'single' : 'group', ts: new Date(latest.timestamp), data: c });
      });
      ungrouped.forEach(function(r) {
        items.push({ type: 'ungrouped', ts: new Date(r.timestamp), data: r });
      });
      items.sort(function(a, b) { return b.ts - a.ts; });

      let html = '';
      items.forEach(function(item) {
        if (item.type === 'single') {
          html += renderSingleCard(item.data.entries[0]);
        } else if (item.type === 'group') {
          html += renderConversationGroup(item.data);
        } else {
          html += renderSingleCard(item.data);
        }
      });
      container.innerHTML = html;
    }

    async function fetchRequests() {
      try {
        const response = await fetch('/api/requests');
        const data = await response.json();
        if (JSON.stringify(data) !== JSON.stringify(currentData)) {
          currentData = data;
          renderConversations(data);
        }
      } catch (err) {
        console.error('Failed to fetch requests:', err);
      }
    }

    fetchRequests();
    setInterval(fetchRequests, 2000);
  </script>
</body>
</html>
